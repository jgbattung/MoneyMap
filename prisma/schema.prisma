generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   String                @id
  name                 String
  email                String                @unique
  emailVerified        Boolean
  image                String?
  createdAt            DateTime
  updatedAt            DateTime
  netWorthTarget       Decimal?              @db.Decimal(15, 2)
  netWorthTargetDate   DateTime?             @db.Timestamp(6)
  accounts             Account[]
  expenseSubcategories ExpenseSubcategory[]
  expenseTransactions  ExpenseTransaction[]
  expenseTypes         ExpenseType[]
  financialAccounts    FinancialAccount[]
  incomeTransactions   IncomeTransaction[]
  incomeTypes          IncomeType[]
  sessions             Session[]
  transferTransactions TransferTransaction[]
  transferTypes        TransferType[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

model FinancialAccount {
  id                  String                @id @default(cuid())
  userId              String                @map("user_id")
  name                String
  accountType         AccountType           @map("account_type")
  initialBalance      Decimal               @map("initial_balance") @db.Decimal(15, 2)
  currentBalance      Decimal               @map("current_balance") @db.Decimal(15, 2)
  addToNetWorth       Boolean               @default(true) @map("add_to_net_worth")
  statementDate       Int?                  @map("statement_date")
  dueDate             Int?                  @map("due_date")
  cardGroup                    String?      @map("card_group")
  statementBalance             Decimal?     @map("statement_balance") @db.Decimal(15, 2)
  previousStatementBalance     Decimal?     @map("previous_statement_balance") @db.Decimal(15, 2)
  lastStatementCalculationDate DateTime?    @map("last_statement_calculation_date") @db.Timestamp(6)
  createdAt           DateTime              @default(now()) @map("created_at")
  updatedAt           DateTime              @updatedAt @map("updated_at")
  expenseTransactions ExpenseTransaction[]
  user                User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  incomeTransactions  IncomeTransaction[]
  transfersFrom       TransferTransaction[] @relation("TransferFrom")
  transfersTo         TransferTransaction[] @relation("TransferTo")

  @@map("financial_accounts")
}

model ExpenseType {
  id                  String               @id @default(cuid())
  userId              String               @map("user_id")
  name                String               @db.VarChar(50)
  monthlyBudget       Decimal?             @map("monthly_budget") @db.Decimal(15, 2)
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  isSystem            Boolean              @default(false) @map("is_system")
  subcategories       ExpenseSubcategory[]
  expenseTransactions ExpenseTransaction[]
  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@map("expense_types")
}

model ExpenseSubcategory {
  id                  String               @id @default(cuid())
  userId              String               @map("user_id")
  expenseTypeId       String               @map("expense_type_id")
  name                String               @db.VarChar(50)
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  expenseType         ExpenseType          @relation(fields: [expenseTypeId], references: [id], onDelete: Cascade)
  user                User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  expenseTransactions ExpenseTransaction[]

  @@unique([expenseTypeId, name])
  @@map("expense_subcategories")
}

model ExpenseTransaction {
  id                    String               @id @default(cuid())
  userId                String               @map("user_id")
  accountId             String               @map("account_id")
  expenseTypeId         String               @map("expense_type_id")
  name                  String
  amount                Decimal              @db.Decimal(15, 2)
  date                  DateTime             @db.Timestamp(6)
  description           String?
  isInstallment         Boolean              @default(false) @map("is_installment")
  installmentDuration   Int?                 @map("installment_duration")
  remainingInstallments Int?                 @map("remaining_installments")
  installmentStartDate  DateTime?            @map("installment_start_date") @db.Timestamp(6)
  monthlyAmount         Decimal?             @map("monthly_amount") @db.Decimal(15, 2)
  createdAt             DateTime             @default(now()) @map("created_at")
  updatedAt             DateTime             @updatedAt @map("updated_at")
  lastProcessedDate     DateTime?            @map("last_processed_date") @db.Timestamp(6)
  isSystemGenerated     Boolean              @default(false) @map("is_system_generated")
  parentInstallmentId   String?              @map("parent_installment_id")
  installmentStatus     String?              @default("ACTIVE") @map("installment_status")
  expenseSubcategoryId  String?              @map("expense_subcategory_id")
  account               FinancialAccount     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  expenseSubcategory    ExpenseSubcategory?  @relation(fields: [expenseSubcategoryId], references: [id])
  expenseType           ExpenseType          @relation(fields: [expenseTypeId], references: [id])
  user                  User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  linkedTransfer        TransferTransaction? @relation("TransferFee")

  @@index([accountId, date])
  @@index([userId, date])
  @@map("expense_transactions")
}

model IncomeType {
  id                 String              @id @default(cuid())
  userId             String              @map("user_id")
  name               String              @db.VarChar(50)
  monthlyTarget      Decimal?            @map("monthly_target") @db.Decimal(15, 2)
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  incomeTransactions IncomeTransaction[]
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@map("income_types")
}

model IncomeTransaction {
  id           String           @id @default(cuid())
  userId       String           @map("user_id")
  accountId    String           @map("account_id")
  incomeTypeId String           @map("income_type_id")
  name         String           @db.VarChar(100)
  amount       Decimal          @db.Decimal(15, 2)
  date         DateTime         @db.Timestamp(6)
  description  String?
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  account      FinancialAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  incomeType   IncomeType       @relation(fields: [incomeTypeId], references: [id], onDelete: Cascade)
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([accountId, date])
  @@index([userId, date])
  @@map("income_transactions")
}

model TransferType {
  id                   String                @id @default(cuid())
  userId               String                @map("user_id")
  name                 String                @db.VarChar(50)
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  transferTransactions TransferTransaction[]
  user                 User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@map("transfer_types")
}

model TransferTransaction {
  id             String              @id @default(cuid())
  userId         String              @map("user_id")
  amount         Float
  fromAccountId  String              @map("from_account_id")
  toAccountId    String              @map("to_account_id")
  transferTypeId String              @map("transfer_type_id")
  date           DateTime            @db.Timestamp(6)
  notes          String?
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")
  name           String              @db.VarChar(100)
  feeAmount      Decimal?            @map("fee_amount") @db.Decimal(15, 2)
  feeExpenseId   String?             @unique @map("fee_expense_id")
  feeExpense     ExpenseTransaction? @relation("TransferFee", fields: [feeExpenseId], references: [id])
  fromAccount    FinancialAccount    @relation("TransferFrom", fields: [fromAccountId], references: [id], onDelete: Cascade)
  toAccount      FinancialAccount    @relation("TransferTo", fields: [toAccountId], references: [id], onDelete: Cascade)
  transferType   TransferType        @relation(fields: [transferTypeId], references: [id])
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([fromAccountId, date])
  @@index([toAccountId, date])
  @@index([userId, date])
  @@map("transfer_transactions")
}

enum AccountType {
  CHECKING
  SAVINGS
  CREDIT_CARD
  INVESTMENT
  CASH
  CRYPTO
  RETIREMENT
  REAL_ESTATE
  OTHER
  PAYROLL
  E_WALLET
}
